@model EnergyManagerCore.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}
<div class="container mt-4">
    <h1 class="mb-4">Energy Manager Dashboard</h1>
    <div class="alert alert-info mt-3">
        👤 Logged in as: <strong>@Model.UserName</strong> (ID: @Model.UserId)
    </div>
    <div class="row">
        <div class="col-md-8">
            <h2>My Houses</h2>
            <ul id="housesList" class="list-group">
                @if (!Model.Houses.Any())
                {
                    <li class="list-group-item text-danger">No houses found</li>
                }
                else
                {
                    @foreach (var house in Model.Houses)
                    {
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <strong>@house.Name</strong>
                            </div>
                            <ul class="list-group mt-2">
                                @foreach (var device in house.Devices)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>@device.Name <small class="text-muted">(@device.Type)</small></span>
                                        <span style="color:red; font-weight:bold;">@device.TotalMeasurement</span>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                }
            </ul>
        </div>
        <div class="col-md-4">
            <h2>Recommendations</h2>
            <div id="recommendations" class="d-flex flex-column"></div>
            <button id="autoOptimize" class="btn btn-primary mt-3">Auto Optimize</button>
            <button id="generateReport" class="btn btn-secondary mt-2">Form Report</button>
        </div>
    </div>
</div>

<script>
    const API = "https://energymanagerapi.onrender.com/api/v1";
    const userId = @System.Text.Json.JsonSerializer.Serialize(Model.UserId);
    const token = sessionStorage.getItem("jwt");
    console.log("Dashboard loaded. userId =", userId);
    if (!token) {
        console.warn("NO JWT TOKEN!");
    }
        document.getElementById("generateReport").addEventListener("click", async () => {
        try {
            const response = await fetch(`${API}/report/pdf`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });
            if (!response.ok) {
                throw new Error("Failed to generate report");
            }
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "energy_report.pdf";
            a.click();
            window.URL.revokeObjectURL(url);
        } catch (error) {
            alert("Error: " + error.message);
        }
    });
</script>